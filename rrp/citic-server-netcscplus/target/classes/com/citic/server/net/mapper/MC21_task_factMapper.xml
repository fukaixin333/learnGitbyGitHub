<?xml version="1.0" encoding="UTF-8"?> 
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.citic.server.net.mapper.MC21_task_factMapper">
	<!-- 查询待处理的任务清单 -->
	<select id="queryNextExecutoryTaskList" parameterType="String" resultType="com.citic.server.service.domain.MC21_task_fact">
		SELECT * FROM ${tablename}
		WHERE (serverid is null OR serverid = '')
		<if test="tasktype != null and tasktype != ''">
			AND tasktype = #{tasktype}
		</if>
		<if test="serverid != null and serverid != ''">
			AND taskid in (SELECT taskid FROM mc21_task WHERE serverid = #{serverid})
		</if>
		ORDER BY datatime ASC
	</select>

    <select id="getMC21_task_factList" parameterType="com.citic.server.service.domain.MC21_task_fact" resultType="com.citic.server.service.domain.MC21_task_fact">
        SELECT t1.*
        FROM ${facttablename} t1
        LEFT JOIN ${statustablename} t2 ON t1.taskkey = t2.taskkey
        WHERE t2.taskid is null
        <if test="tasktype != null and tasktype != ''">
            AND tasktype = #{tasktype}
        </if>
        <if test="serverid != null and serverid != ''">
            AND t1.taskid in (select taskid from MC21_TASK where serverid = #{serverid})
        </if>
        ORDER BY t1.taskkey, t1.datatime
    </select>

    <select id="getMC22_task_factList" parameterType="com.citic.server.service.domain.MC21_task_fact" resultType="com.citic.server.service.domain.MC21_task_fact">
        select t1.taskkey, t1.taskid,
        t1.subtaskid,
        t1.datatime,
        t1.serverid,
        t1.taskname,
        t1.tgroupid,
        t1.freq,
        t1.taskcmd
        from MC22_TASK_FACT t1
        left join MC22_TASK_STATUS t2
        on t1.taskkey = t2.taskkey
        where t2.taskid is null
        <if test="tasktype != null  and tasktype != '' ">
            AND tasktype = #{tasktype}
        </if>
        <if test="serverid != null  and serverid != '' ">
            and t1.taskid in (select taskid from MC22_TASK where serverid = #{serverid} )
        </if>
        order by t1.taskkey, t1.datatime
    </select>

    <update id="lockTask" parameterType="com.citic.server.service.domain.MC21_task_fact">
        UPDATE ${facttablename} SET serverid = #{serverid}
        WHERE taskkey = #{taskkey} AND (serverid is null OR serverid = '')
    </update>

    <update id="updateMC21_task_fact" parameterType="com.citic.server.service.domain.MC21_task_fact">
	<![CDATA[
		update ${facttablename}  f set f.serverid='' where taskkey=#{taskkey} 
	]]>
    </update>

    <insert id="insertMC21_task_status" parameterType="com.citic.server.service.domain.MC21_task_status">
        insert into ${statustablename} (
        taskkey,taskid,subtaskid,datatime,serverid,freq,taskname,tgroupid,begintime,endtime,usetime,calstatus,taskcmd
        )
        values(
        #{taskkey},#{taskid},#{subtaskid},#{datatime},#{serverid},#{freq},#{taskname},#{tgroupid},#{begintime},#{endtime},#{usetime},#{calstatus},#{taskcmd}
        )
    </insert>
    
    <update id="deleteMC21_task_status" parameterType="com.citic.server.service.domain.MC21_task_status">
    	DELETE FROM ${statustablename} WHERE taskkey = #{taskkey}
    </update>

    <select id="getMC21_taskList" resultType="com.citic.server.service.domain.MC21_task">
        SELECT taskid,taskname,tasktype,serverid,taskcmd,isemployee,flag,isdyna,exectime,multithread FROM mc21_task
    </select>

 	<delete id="resetAllMC21_task_status" parameterType="com.citic.server.service.domain.MC21_task_fact">
	<![CDATA[
		delete from  ${statustablename} 
		where serverid = '${serverid}' and calstatus <> '1'
	]]>
	</delete>
	
	<update id="unLockAllTask" parameterType="String">
	<![CDATA[
		update ${facttablename} f set f.serverid='' where f.serverid=#{serverid} 
			and f.taskkey not in (select s.taskkey from   ${statustablename}  s 
			where s.taskkey=f.taskkey  and s.calstatus='1')
	]]>	
	</update>
</mapper> 
